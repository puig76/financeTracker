@page "/edit-user" 
@using FinanceTracker.Web.Clients
@using FinanceTracker.Web.Models

@inject AuthApiClient AuthService
@inject NavigationManager Navigation
@inject IToastService ToastService

<h3>EditUser</h3>

    <EditForm Model="@updateUser" OnValidSubmit="@HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="form-group mb-3">
            <label for="username">Username</label>
            <InputText id="username" class="form-control" @bind-Value="updateUser.Username" />
        </div>

        <div class="form-group mb-3">
            <label for="email">Email</label>
            <InputText id="email" type="email" class="form-control" @bind-Value="updateUser.Email" />
        </div>

        <button type="submit" class="btn btn-primary">Update User</button>
    </EditForm>

@code {
    private UpdateUser updateUser = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            return;
        }

        try
        {
            var userInfo = await AuthService.GetCurrentUserAsync();
            updateUser = new UpdateUser
            {
                Username = userInfo.Username,
                Email = userInfo.Email
            };
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error fetching user info: {ex.Message}");
        }

        StateHasChanged();
    }

    private async Task HandleValidSubmit()
    {
        var result = await AuthService.UpdateUserProfileAsync(updateUser);
        if (result)
        {
            ToastService.ShowSuccess("User profile updated successfully.");
            Navigation.NavigateTo("/userinfo");
        }
        else
        {
            ToastService.ShowError("Failed to update user profile.");
        }
    }
}
